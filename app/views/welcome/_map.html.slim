/ this file integrates the map in various places on the website

#sidebar
div#map data-addresses=user_addresses_as_json class=(defined?(classname)? classname : "")

#shop-info


= stylesheet_link_tag "https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
= stylesheet_link_tag "https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/leaflet-sidebar@0.2.0/src/L.Control.Sidebar.css"

= javascript_include_tag "https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
= javascript_include_tag "https://cdn.jsdelivr.net/npm/leaflet-sidebar@0.2.0/src/L.Control.Sidebar.min.js"


css:
    #map {
        z-index: 0;
        position: relative;
        height: 500px; 
        width: 100%;
        padding-top: 50px;
    }

    #map.embedded {
        position: absolute;
        right: 0;
        width: 50% !important;
    }

    .nxt-content {
        z-index: 1;
        position: absolute;
        width: 100%;
    }

    .navbar {
        height: 50px;
        width: 100%;
    }

javascript:
    // initialize the map
    var map = L.map('map', { zoomControl: #{defined?(zoomControl) ? zoomControl : true } }).setView([52.511946, 13.406166], 12);
    var imgNotAvailable = 'https://www.postfreeadvertising.com/wp-content/uploads/2018/08/no-image-available-grid-263x172.png'
    var toBeUsedTile = 'https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/{z}/{x}/{y}?access_token={accessToken}'
    var stadiamaps = 'https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}.png'
    var osmMap = 'https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png'
    var cartoDB = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
    // load a tile layer
    L.tileLayer(
    toBeUsedTile,
    {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 16,
        minZoom: 11,
        //accessToken: 'pk.eyJ1IjoibXl1c2VybmFtZWlzdGhpcyIsImEiOiJjazhndmhzNmYwNHV3M3NzMDcwNGs1ZjZzIn0.2ZRug8MHanm-5yQd9ptfGg',
        accessToken: 'pk.eyJ1IjoiaGVzc2xhdSIsImEiOiJjazhpcmFxbmwwMmR5M2hwYWptbGdsbXNuIn0.uvVb2KclwLDJGMbr_PgXaQ',
        tileSize: 512,
        zoomOffset: -1
    }
    ).addTo(map);

    map.zoomControl.setPosition('bottomleft');
    // create markers and set that sidebar opens and closes when click on marker

    shop_data = JSON.parse(document.querySelector('#map').dataset.addresses)
    //sidebar = document.querySelector('#shop-info')

    var sidebar = L.control.sidebar('sidebar', {
      closeButton: false,
      position: 'right',
      autoPan: false,
    });
    map.addControl(sidebar);

    function create_markers(val, idx, array) {
        console.log(val);
        var sidebarContent = (
            `<div>
            <img src="${val['logo']}" alt="" style="width:250px" class="rounded">
            <br>
            <h4>${val['company_name']}</h4>
            <hr>
            <p class="text-justify">
            ${val['about']}
            </p>
            <hr>
            <img src="#{image_url("map/location_icon.png")}" style="width:20px"> ${val['address']}
            <br> <br>
            <img src="#{image_url("map/home_icon.png")}" style="width:20px">  <a href="${val['shop_url']}">online shop</a>
            </div>`
        )

        function onClickMarker(e) {
            if (idx == sidebar.state) {
                sidebar.hide()
                sidebar.state = array.lengths
            } else {
                sidebar.setContent(sidebarContent);
                sidebar.state = idx
                sidebar.show();
            }
        }

        marker = L.marker([val['latitude'], val['longitude']])
        marker.addTo(map);
        marker.on('click', onClickMarker);
    };

    shop_data.forEach(create_markers);